<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Montador de Cifras - Tocaí</title>
    <link rel="stylesheet" href="cifra.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Fira+Code&display=swap"
        rel="stylesheet">
</head>

<body>
    <h1>Montador de Cifras</h1>
    <h2>Crie cifras no estilo Tocaí</h2>

    <div class="container">
        <div class="editor-section">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="openTab('metadata')">Metadados</button>
                <button class="tab-btn" onclick="openTab('lyrics')">Letra</button>
                <button class="tab-btn" onclick="openTab('chords')">Acordes</button>
                <button class="tab-btn" onclick="openTab('tabs')">Tablaturas</button>
            </div>

            <div id="metadata" class="tab-content active">
                <div class="form-group">
                    <label for="song-title">Título da Música</label>
                    <input type="text" id="song-title" placeholder="Digite o título da música">
                </div>

                <div class="form-group">
                    <label for="artist">Artista/Banda</label>
                    <input type="text" id="artist" placeholder="Nome do artista ou banda">
                </div>

                <div class="form-group">
                    <label for="song-key">Tom da Música</label>
                    <select id="song-key">
                        <option value="">Selecione o tom</option>
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tuning">Afinacao</label>
                    <select id="tuning">
                        <option value="">Afinacao padrão (EADGBE)</option>
                        <option value="DADGBE">DADGBE (Dropped D)</option>
                        <option value="DADGAD">DADGAD</option>
                        <option value="DGDGBD">DGDGBD (Open G)</option>
                        <option value="CGCGCE">CGCGCE (Open C)</option>
                        <option value="EBEG#BE">EBEG#BE (Open E)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="capo">Capotraste</label>
                    <input type="text" id="capo" placeholder="Ex: 2ª casa">
                </div>
            </div>

            <div id="lyrics" class="tab-content">
                <div class="form-group">
                    <label for="song-lyrics">Letra da Música</label>
                    <textarea id="song-lyrics" placeholder="Digite a letra da música aqui..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="addSection('Intro')">+ Intro</button>
                    <button class="btn" onclick="addSection('Verso')">+ Verso</button>
                    <button class="btn" onclick="addSection('Refrão')">+ Refrão</button>
                    <button class="btn" onclick="addSection('Ponte')">+ Ponte</button>
                    <button class="btn" onclick="addSection('Solo')">+ Solo</button>
                </div>
            </div>

            <div id="chords" class="tab-content">
                <div class="form-group">
                    <label for="chord-input">Acorde</label>
                    <input type="text" id="chord-input" placeholder="Ex: C, G7, Am">
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="addChord()">Adicionar Acorde</button>
                    <button class="btn btn-accent" onclick="insertChord()">Inserir na Letra</button>
                </div>

                <div class="section-title">Acordes Adicionados</div>
                <div id="chords-list" class="preview" style="min-height: 100px;"></div>
            </div>

            <div id="tabs" class="tab-content">
                <div class="form-group">
                    <label>Tablatura</label>
                    <div class="tab-editor"></div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="insertTab()">Adicionar Tab na Letra</button>
                    <button class="btn" onclick="clearTabEditor()">Limpar Tab</button>
                </div>
            </div>
        </div>

        <div class="preview-section">
            <h3>Pré-visualização da Cifra</h3>
            <div id="cifra-preview" class="preview"></div>

            <div class="btn-group">
                <button class="btn btn-accent" onclick="copyCifra()">Copiar Cifra</button>
                <button class="btn" onclick="clearAll()">Limpar Tudo</button>
            </div>

            <div id="status" class="status"></div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let chords = [];
        let tabs = [];
        let currentChord = '';

        // Funções de abas
        function openTab(tabId) {
            // Esconde todos os conteúdos de abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove a classe active de todos os botões
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostra a aba selecionada
            document.getElementById(tabId).classList.add('active');

            // Ativa o botão da aba selecionada
            event.currentTarget.classList.add('active');
        }

        // Funções para letra
        function addSection(sectionName) {
            const lyricsTextarea = document.getElementById('song-lyrics');
            const cursorPos = lyricsTextarea.selectionStart;
            const textBefore = lyricsTextarea.value.substring(0, cursorPos);
            const textAfter = lyricsTextarea.value.substring(cursorPos);

            let sectionText = `\n\n[${sectionName}]\n`;

            lyricsTextarea.value = textBefore + sectionText + textAfter;
            lyricsTextarea.focus();
            lyricsTextarea.selectionStart = cursorPos + sectionText.length;
            lyricsTextarea.selectionEnd = cursorPos + sectionText.length;

            updatePreview();
            generateCifra(); // <-- Adicione esta linha
        }

        // Funções para acordes
        function addChord() {
            const chordInput = document.getElementById('chord-input');
            const chord = chordInput.value.trim();

            if (chord && !chords.includes(chord)) {
                chords.push(chord);
                updateChordsList();
                chordInput.value = '';
                currentChord = chord;
                mostrarStatus(`Acorde ${chord} adicionado!`, true);
                generateCifra(); // <-- Adicione esta linha
            }
        }

        function insertChord() {
            const lyricsTextarea = document.getElementById('song-lyrics');
            const cursorPos = lyricsTextarea.selectionStart;
            const textBefore = lyricsTextarea.value.substring(0, cursorPos);
            const textAfter = lyricsTextarea.value.substring(cursorPos);

            if (!currentChord && chords.length > 0) {
                currentChord = chords[0];
            }

            if (currentChord) {
                const chordTag = `[${currentChord}]`;
                lyricsTextarea.value = textBefore + chordTag + textAfter;
                lyricsTextarea.focus();
                lyricsTextarea.selectionStart = cursorPos + chordTag.length;
                lyricsTextarea.selectionEnd = cursorPos + chordTag.length;

                updatePreview();
                generateCifra(); // <-- Adicione esta linha
            } else {
                mostrarStatus("Nenhum acorde selecionado!", false);
            }
        }

        function updateChordsList() {
            const chordsList = document.getElementById('chords-list');
            chordsList.innerHTML = chords.map(chord =>
                `<span class="chord-item" onclick="selectChord('${chord}')">${chord}</span>`
            ).join(' ');
        }

        function selectChord(chord) {
            currentChord = chord;
            mostrarStatus(`Acorde ${chord} selecionado para inserção`, true);
        }

        // Funções para tablaturas
        // Editor de tablatura simples
        const tabTemplate = `
e|-----------------------------------------------------------------------|
B|-----------------------------------------------------------------------|
G|-----------------------------------------------------------------------|
D|-----------------------------------------------------------------------|
A|-----------------------------------------------------------------------|
E|-----------------------------------------------------------------------|
`;

        const tuningsTemplates = {
            "": [
                "e|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|",
                "A|-----------------------------------------------------------------------|",
                "E|-----------------------------------------------------------------------|"
            ],
            "DADGBE": [
                "e|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|",
                "A|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|"
            ],
            "DADGAD": [
                "e|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|",
                "A|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|"
            ],
            "DGDGBD": [
                "D|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "D|-----------------------------------------------------------------------|"
            ],
            "CGCGCE": [
                "e|-----------------------------------------------------------------------|",
                "C|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "C|-----------------------------------------------------------------------|",
                "G|-----------------------------------------------------------------------|",
                "C|-----------------------------------------------------------------------|"
            ],
            "EBEG#BE": [
                "e|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "G#|-----------------------------------------------------------------------|",
                "E|-----------------------------------------------------------------------|",
                "B|-----------------------------------------------------------------------|",
                "E|-----------------------------------------------------------------------|"
            ]
        };

        function renderTabEditor(tuning = document.getElementById('tuning').value) {
            const templateLines = tuningsTemplates[tuning] || tuningsTemplates[""];
            const tabEditor = document.querySelector('.tab-editor');
            tabEditor.innerHTML = templateLines.map(line => {
                return `<div class="tab-line">` +
                    line.split("").map(e => {
                        if (e === "-" || e.match(/[0-9+]/))
                            return `<span class='is-editable'>${e}</span>`;
                        return `<span>${e}</span>`;
                    }).join("") +
                    `</div>`;
            }).join("");

            tabEditor.querySelectorAll('.is-editable').forEach(span => {
                span.addEventListener('click', function (e) {
                    const html = e.target.innerHTML;
                    e.target.innerHTML = "<input style='width:18px'>";
                    const input = e.target.querySelector("input");
                    if (html != "-") input.value = html;
                    input.focus();
                    input.addEventListener("blur", b => {
                        const value = b.target.value != "" ? b.target.value : "-";
                        e.target.innerHTML = `${value}`;
                    });
                });
            });
        }

        // =======================================================
        // FUNÇÃO CORRIGIDA
        // =======================================================
        function getTabFromEditor() {
            const tabEditor = document.querySelector('.tab-editor');
            // Seleciona todas as divs de linha e junta seus conteúdos com uma quebra de linha
            const lines = Array.from(tabEditor.querySelectorAll('.tab-line'));
            return lines.map(line => line.textContent).join('\n');
        }
        // =======================================================

        function clearTabEditor() {
            renderTabEditor();
        }

        // Insere a tab na letra na posição do cursor
        function insertTab() {
            const tab = getTabFromEditor().trim();
            if (!tab || !tab.includes('|')) {
                mostrarStatus("Tablatura vazia!", false);
                return;
            }
            const lyricsTextarea = document.getElementById('song-lyrics');
            const cursorPos = lyricsTextarea.selectionStart;
            const textBefore = lyricsTextarea.value.substring(0, cursorPos);
            const textAfter = lyricsTextarea.value.substring(cursorPos);

            // Marca a tab para o preview processar depois
            const tabTag = `\n[TAB]\n${tab}\n[/TAB]\n`;
            lyricsTextarea.value = textBefore + tabTag + textAfter;
            lyricsTextarea.focus();
            lyricsTextarea.selectionStart = cursorPos + tabTag.length;
            lyricsTextarea.selectionEnd = cursorPos + tabTag.length;

            generateCifra();
            mostrarStatus("Tablatura inserida na letra!", true);
        }

        // Inicializa o editor ao carregar
        renderTabEditor(document.getElementById('tuning').value);

        // Funções para gerar a cifra
        function generateCifra() {
            const title = document.getElementById('song-title').value.trim();
            const artist = document.getElementById('artist').value.trim();
            const key = document.getElementById('song-key').value;
            const tuning = document.getElementById('tuning').value;
            const capo = document.getElementById('capo').value.trim();
            const lyrics = document.getElementById('song-lyrics').value;

            if (!title || !lyrics) {
                mostrarStatus("Título e letra são obrigatórios!", false);
                return;
            }

            let cifraHTML = `<div class="tocai-tab-container">
                <h1 class="tocai-title">${title}</h1>
                <span class="tocai-artist">${artist || 'Artista desconhecido'}</span>`;

            // Adiciona metadados se existirem
            if (key || tuning || capo) {
                cifraHTML += `<div class="tocai-meta">`;
                if (key) cifraHTML += `<span class="tocai-key">Tom: ${key}</span>`;
                if (tuning) cifraHTML += `<span class="tocai-tuning">Afinacao: ${tuning}</span>`;
                if (capo) cifraHTML += `<span class="tocai-capo">Capotraste: ${capo}</span>`;
                cifraHTML += `</div>`;
            }

            // Processa a letra com acordes e tablaturas
            let processedLyrics = lyrics
                .replace(/\[TAB\]([\s\S]*?)\[\/TAB\]/g, '<pre class="tocai-tablature">$1</pre>')
                .replace(/\[([^\]]+)\]/g, function (match, p1) {
                    // Não estiliza acordes dentro de TAB
                    if (match.startsWith('[TAB') || match.startsWith('[/TAB')) return match;
                    return `<span class="tocai-chord">${p1}</span>`;
                });

            // Adiciona a letra
            cifraHTML += `<div class="tocai-tab-font">${processedLyrics.replace(/\n/g, '<br>')}</div>`;

            // Adiciona tablaturas se existirem
            if (tabs.length > 0) {
                cifraHTML += `<div class="tocai-tablature"><pre>${tabs.join('\n\n')}</pre></div>`;
            }

            cifraHTML += `</div>`;

            document.getElementById('cifra-preview').innerHTML = cifraHTML;
            mostrarStatus("Cifra gerada com sucesso!", true);
        }

        function copyCifra() {
            const preview = document.getElementById('cifra-preview');
            if (!preview.innerHTML.trim()) {
                mostrarStatus("Nada para copiar - gere a cifra primeiro!", false);
                return;
            }

            const range = document.createRange();
            range.selectNode(preview);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    mostrarStatus("Cifra copiada para a área de transferência!", true);
                } else {
                    mostrarStatus("Falha ao copiar a cifra", false);
                }
            } catch (err) {
                mostrarStatus("Erro ao copiar: " + err, false);
            }

            window.getSelection().removeAllRanges();
        }

        function clearAll() {
            if (confirm("Tem certeza que deseja limpar tudo?")) {
                document.getElementById('song-title').value = '';
                document.getElementById('artist').value = '';
                document.getElementById('song-key').value = '';
                document.getElementById('tuning').value = '';
                document.getElementById('capo').value = '';
                document.getElementById('song-lyrics').value = '';
                document.getElementById('chord-input').value = '';
                document.getElementById('tab-content').value = '';

                chords = [];
                tabs = [];
                currentChord = '';

                updateChordsList();
                // A função updateTabsList não existe no seu código original, então comentei para evitar erros.
                // updateTabsList(); 
                document.getElementById('cifra-preview').innerHTML = '';

                mostrarStatus("Todos os campos foram limpos!", true);
            }
        }

        function updatePreview() {
            // Atualizações em tempo real podem ser adicionadas aqui
        }

        function mostrarStatus(mensagem, sucesso) {
            const statusElement = document.getElementById("status");
            statusElement.textContent = mensagem;
            statusElement.className = sucesso ? "status success" : "status error";
            statusElement.style.display = "block";

            setTimeout(() => {
                statusElement.style.opacity = "0";
                setTimeout(() => {
                    statusElement.style.display = "none";
                    statusElement.style.opacity = "1";
                }, 500);
            }, 3000);
        }

        // Atualiza cifra ao digitar nos campos principais
        document.getElementById('song-title').addEventListener('input', generateCifra);
        document.getElementById('artist').addEventListener('input', generateCifra);
        document.getElementById('song-key').addEventListener('change', generateCifra);
        document.getElementById('tuning').addEventListener('change', function() {
            renderTabEditor(this.value);
            generateCifra();
        });
        document.getElementById('capo').addEventListener('input', generateCifra);
        document.getElementById('song-lyrics').addEventListener('input', generateCifra);
    </script>
</body>

</html>